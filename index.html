<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WalletFlow | Habit-Linked Expense Tracker</title>
  <link rel="icon" type="image/x-icon" href="logo.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center py-4 px-6">
      <h1 class="text-xl font-bold flex items-center gap-2">
        <img src="logo.jpg" alt="WalletFlow" class="w-12 h-12 rounded-full">
        WalletFlow
      </h1>
      <nav class="hidden md:flex items-center gap-6">
        <a href="index.html" class="text-gray-600 hover:text-indigo-600">Dashboard</a>
        <a href="new_habit.html" class="text-gray-600 hover:text-indigo-600">Habits</a>
        <a href="report.html" class="text-gray-600 hover:text-indigo-600">Reports</a>

        <button
          class="logoutBtn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </nav>

      <button id="menu-btn" class="md:hidden text-gray-600">
        <i class="fa-solid fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-50 flex justify-end">
      <!-- Dark background -->
      <div id="overlay" class="absolute inset-0 bg-black bg-opacity-50"></div>

      <!-- Drawer -->
      <div id="drawer" class="relative w-64 bg-white h-full shadow-lg flex flex-col p-6 space-y-4 
              transform translate-x-full transition-transform duration-300">
        <button id="close-menu" class="self-end text-gray-600">
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
        <a href="index.html" class="block text-gray-600 hover:text-indigo-600">Dashboard</a>
        <a href="new_habit.html" class="block text-gray-600 hover:text-indigo-600">Habits</a>
        <a href="report.html" class="block text-gray-600 hover:text-indigo-600">Reports</a>
        <button
          class="logoutBtn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center gap-2">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </div>
    </div>

    <script>
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const drawer = document.getElementById("drawer");
      const overlay = document.getElementById("overlay");
      const closeBtn = document.getElementById("close-menu");

      // Open menu
      menuBtn.addEventListener("click", () => {
        mobileMenu.classList.remove("hidden");
        setTimeout(() => {
          drawer.classList.remove("translate-x-full");
        }, 10); // allow reflow before animating
      });

      // Close menu
      function closeMenu() {
        drawer.classList.add("translate-x-full");
        setTimeout(() => {
          mobileMenu.classList.add("hidden");
        }, 300); // match duration-300
      }

      closeBtn.addEventListener("click", closeMenu);
      overlay.addEventListener("click", closeMenu);
    </script>

  </header>

  <!-- Dashboard Content -->
  <main class="container mx-auto flex-grow px-4 py-6">
    <h1 class="text-2xl mb-6 font-bold text-center">Dashboard</h1>
    <!-- Top Budget Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between gap-4">
        <!-- Left: Icon + Text -->
        <div class="flex items-center gap-4">
          <i class="fa-solid fa-face-smile text-green-500 text-3xl"></i>
          <div>
            <h2 class="text-lg font-semibold">Fun Budget</h2>
            <p id="funBudget" class="text-2xl font-bold">â‚¹0</p>
          </div>
        </div>

        <!-- Right: Add Money Button -->
        <button id="add-fun-money"
          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow">
          + Add
        </button>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
        <i class="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i>
        <div>
          <h2 class="text-lg font-semibold">Penalty Jar</h2>
          <p id="penaltyJar" class="text-2xl font-bold">â‚¹0</p>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-chart-line text-indigo-600"></i> Habit Streaks & Financial Movement
      </h2>
      <canvas id="habitChart" height="120"></canvas>
    </div>


    <!-- Login Modal -->
    <!-- Login/Signup Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
      <div class="bg-white bg-opacity-90 backdrop-blur-md p-6 rounded-2xl shadow-xl w-full max-w-md">
        <!-- Tabs -->
        <div class="flex justify-center mb-6 space-x-4">
          <button id="loginTab"
            class="px-4 py-2 font-semibold border-b-2 border-indigo-600 text-indigo-600">Login</button>
          <button id="signupTab"
            class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-400">Sign Up</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="flex flex-col space-y-4">
          <div class="relative">
            <i class="fa-solid fa-envelope absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="loginEmail" type="email" placeholder="Email"
              class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div class="relative">
            <i class="fa-solid fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="loginPassword" type="password" placeholder="Password"
              class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <button type="button" id="toggleLoginPassword"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
          <button id="loginBtn"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition-all duration-300">
            Login
          </button>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" class="hidden flex flex-col space-y-4">
          <div class="relative">
            <i class="fa-solid fa-envelope absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="signupEmail" type="email" placeholder="Email"
              class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
          </div>
          <div class="relative">
            <i class="fa-solid fa-lock absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="signupPassword" type="password" placeholder="Password"
              class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
            <button type="button" id="toggleSignupPassword"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
          <button id="signupBtn"
            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition-all duration-300">
            Sign Up
          </button>
        </form>
      </div>
    </div>

    <!-- Centered Create New Habit Button -->
    <div class="flex justify-center mt-6">
      <a href="new_habit.html"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 hover:scale-105 flex items-center">
        <i class="fas fa-plus mr-2"></i>Create New Habit
      </a>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-white shadow-inner mt-6">
    <div class="container mx-auto py-4 text-sm text-gray-500 px-4">
      <div class="flex flex-col items-center sm:flex-row sm:justify-between">

        <!-- Left side -->
        <span class="mb-2 sm:mb-0">WalletFlow | Powered by Hackanova</span>

        <!-- Right side -->
        <div class="flex space-x-6">
          <a href="helpage.html" class="hover:underline">Blog</a>
          <a href="contact.html" class="hover:underline">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Script -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ðŸ”¹ Replace with your Supabase project keys
    const SUPABASE_URL = "https://tpbfuyibluyflbajdehy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwYmZ1eWlibHV5ZmxiYWpkZWh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNzg5MzIsImV4cCI6MjA3Mzg1NDkzMn0.Y2KczDmRWCz9TuHIBWX8atYtA252p-30kv8iaXRd070";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let habitChartInstance = null;


    async function loadDashboard() {
      try {
        // ðŸ‘‰ Get budgets
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return alert("Please log in first");

        const { data: userData, error } = await supabase
          .from("users")
          .select("fun_budget, penalty_jar")
          .eq("id", user.id)
          .maybeSingle();

        document.getElementById("funBudget").textContent = `â‚¹${userData?.fun_budget || 500}`;
        document.getElementById("penaltyJar").textContent = `â‚¹${userData?.penalty_jar || 0}`;


        // ðŸ‘‰ Get last 7 days habits
        const { data: habits } = await supabase
          .from("habits")
          .select("date, completed, penalty_amount")
          .order("date", { ascending: true })
          .limit(7);

        const labels = habits?.map(h => new Date(h.date).toLocaleDateString("en-IN", { weekday: "short" })) || [];
        const streaks = habits?.map(h => (h.completed ? 1 : 0)) || [];
        const money = habits?.map(h => (h.completed ? 0 : -h.penalty_amount)) || [];

        // Render Chart
        // Render or update Chart
        const ctx = document.getElementById("habitChart").getContext("2d");

        if (habitChartInstance) {
          // Update existing chart
          habitChartInstance.data.labels = labels;
          habitChartInstance.data.datasets[0].data = streaks;
          habitChartInstance.data.datasets[1].data = money;
          habitChartInstance.update();
        } else {
          // Create new chart
          habitChartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Habit Streak",
                  data: streaks,
                  borderColor: "#4f46e5",
                  backgroundColor: "rgba(79,70,229,0.2)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                },
                {
                  label: "Money Shift (â‚¹)",
                  data: money,
                  borderColor: "#ef4444",
                  backgroundColor: "rgba(239,68,68,0.2)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "bottom" } },
            },
          });
        }

      } catch (err) {
        console.error("Error loading dashboard:", err);
      }
    }

    loadDashboard();



    const loginModal = document.getElementById("loginModal");
    const loginTab = document.getElementById("loginTab");
    const signupTab = document.getElementById("signupTab");
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");

    // Tab switching
    loginTab.addEventListener("click", () => {
      loginForm.classList.remove("hidden");
      signupForm.classList.add("hidden");
      loginTab.classList.add("border-indigo-600", "text-indigo-600");
      signupTab.classList.remove("border-green-500", "text-green-500");
    });

    signupTab.addEventListener("click", () => {
      signupForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
      signupTab.classList.add("border-green-500", "text-green-500");
      loginTab.classList.remove("border-indigo-600", "text-indigo-600");
    });

    // Check session
    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        loginModal.classList.remove("hidden");
      } else {
        loginModal.classList.add("hidden");
        loadDashboard(); // call your dashboard function
      }
    }

    checkSession();

    // Login
    document.getElementById("loginBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      loginModal.classList.add("hidden");
      alert("Login successful!");
      setTimeout(loadDashboard, 500);
    });

    // Signup
    document.getElementById("signupBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert("Signup successful! Check you confirmation email.");
      loginTab.click(); // Switch to login
    });

    document.addEventListener("DOMContentLoaded", () => {
      // Logout button for desktop & mobile
      document.querySelectorAll(".logoutBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          try {
            await supabase.auth.signOut();
            // Show login modal
            document.getElementById("loginModal").classList.remove("hidden");
            // Close mobile drawer if open
            const drawer = document.getElementById("drawer");
            const mobileMenu = document.getElementById("mobile-menu");
            drawer.classList.add("translate-x-full");
            setTimeout(() => mobileMenu.classList.add("hidden"), 300);
          } catch (err) {
            console.error("Logout failed:", err);
          }
        });
      });
    });


    function setupPasswordToggle(toggleId, inputId) {
      const toggleBtn = document.getElementById(toggleId);
      const input = document.getElementById(inputId);

      toggleBtn.addEventListener("click", () => {
        const type = input.getAttribute("type") === "password" ? "text" : "password";
        input.setAttribute("type", type);

        toggleBtn.innerHTML =
          type === "password"
            ? '<i class="fa-solid fa-eye"></i>'
            : '<i class="fa-solid fa-eye-slash"></i>';
      });
    }

    // Apply for both login and signup
    setupPasswordToggle("toggleLoginPassword", "loginPassword");
    setupPasswordToggle("toggleSignupPassword", "signupPassword");

    document.getElementById("add-fun-money").onclick = async () => {
      const amount = parseInt(prompt("Enter amount to add:"));
      if (isNaN(amount) || amount <= 0) return;

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert("Please log in first");

      // fetch current user budget
      const { data: userData } = await supabase
        .from("users")
        .select("fun_budget")
        .eq("id", user.id)
        .maybeSingle();

      const newBudget = (userData?.fun_budget || 500) + amount;

      const { data, error } = await supabase
        .from("users")
        .update({ fun_budget: newBudget })
        .eq("id", user.id)
        .select("fun_budget")
        .single();

      if (error) return console.error(error);

      document.getElementById("funBudget").textContent = `â‚¹${data.fun_budget}`;
    };


  </script>
</body>

</html>