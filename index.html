<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WalletFlow | Habit-Linked Expense Tracker</title>
  <link rel="icon" type="image/x-icon" href="logo.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center py-4 px-6">
      <h1 class="text-xl font-bold flex items-center gap-2">
        <img src="logo.jpg" alt="WalletFlow" class="w-12 h-12 rounded-full">
        WalletFlow
      </h1>
      <nav class="hidden md:flex gap-6">
        <a href="index.html" class="text-gray-600 hover:text-indigo-600">Dashboard</a>
        <a href="new_habit.html" class="text-gray-600 hover:text-indigo-600">Habits</a>
        <a href="report.html" class="text-gray-600 hover:text-indigo-600">Reports</a>
      </nav>
      <button id="menu-btn" class="md:hidden text-gray-600">
        <i class="fa-solid fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="hidden fixed inset-0 z-50 flex justify-end">
      <!-- Dark background -->
      <div id="overlay" class="absolute inset-0 bg-black bg-opacity-50"></div>

      <!-- Drawer -->
      <div id="drawer" class="relative w-64 bg-white h-full shadow-lg flex flex-col p-6 space-y-4 
              transform translate-x-full transition-transform duration-300">
        <button id="close-menu" class="self-end text-gray-600">
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
        <a href="index.html" class="block text-gray-600 hover:text-indigo-600">Dashboard</a>
        <a href="new_habit.html" class="block text-gray-600 hover:text-indigo-600">Habits</a>
        <a href="report.html" class="block text-gray-600 hover:text-indigo-600">Reports</a>
      </div>
    </div>

    <script>
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");
      const drawer = document.getElementById("drawer");
      const overlay = document.getElementById("overlay");
      const closeBtn = document.getElementById("close-menu");

      // Open menu
      menuBtn.addEventListener("click", () => {
        mobileMenu.classList.remove("hidden");
        setTimeout(() => {
          drawer.classList.remove("translate-x-full");
        }, 10); // allow reflow before animating
      });

      // Close menu
      function closeMenu() {
        drawer.classList.add("translate-x-full");
        setTimeout(() => {
          mobileMenu.classList.add("hidden");
        }, 300); // match duration-300
      }

      closeBtn.addEventListener("click", closeMenu);
      overlay.addEventListener("click", closeMenu);
    </script>

  </header>

  <!-- Dashboard Content -->
  <main class="container mx-auto flex-grow px-4 py-6">
    <h1 class="text-2xl mb-6 font-bold text-center">Dashboard</h1>
    <!-- Top Budget Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between gap-4">
        <!-- Left: Icon + Text -->
        <div class="flex items-center gap-4">
          <i class="fa-solid fa-face-smile text-green-500 text-3xl"></i>
          <div>
            <h2 class="text-lg font-semibold">Fun Budget</h2>
            <p id="funBudget" class="text-2xl font-bold">â‚¹0</p>
          </div>
        </div>

        <!-- Right: Add Money Button -->
        <button id="add-fun-money"
          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow">
          + Add
        </button>
      </div>
      <script>
        const addMoneyBtn = document.getElementById("add-fun-money");
        const funBudgetDisplay = document.getElementById("funBudget");

        addMoneyBtn.addEventListener("click", async () => {
          const amount = prompt("Enter amount to add:");
          const value = parseInt(amount);

          if (!isNaN(value) && value > 0) {
            // Example: assuming you have a budgets table with user_id = 1
            let { data, error } = await supabase
              .from("budgets")
              .update({ fun_budget: supabase.sql`fun_budget + ${value}` })
              .eq("user_id", "USER_ID_HERE")  // replace with logged-in user's id
              .select("fun_budget")
              .single();

            if (!error) {
              funBudgetDisplay.textContent = `â‚¹${data.fun_budget}`;
            } else {
              console.error(error);
            }
          }
        });
      </script>
      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
        <i class="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i>
        <div>
          <h2 class="text-lg font-semibold">Penalty Jar</h2>
          <p id="penaltyJar" class="text-2xl font-bold">â‚¹0</p>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-6">
      <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-chart-line text-indigo-600"></i> Habit Streaks & Financial Movement
      </h2>
      <canvas id="habitChart" height="120"></canvas>
    </div>


    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
      <div class="bg-white p-6 rounded-xl shadow-lg w-80">
        <h2 class="text-xl font-bold mb-4 text-center">Login to Continue</h2>
        <input id="email" type="email" placeholder="Email"
          class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" />
        <input id="password" type="password" placeholder="Password"
          class="w-full mb-3 px-3 py-2 border rounded-lg focus:outline-none" />

        <button id="loginBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg mb-2">Login</button>
        <button id="signupBtn" class="w-full bg-gray-200 py-2 rounded-lg">Sign Up</button>
      </div>
    </div>

    <a href="new_habit.html"
      class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 hover:scale-105">
      <i class="fas fa-plus mr-2"></i>Create New Habit
    </a>
  </main>

  <!-- Footer -->
  <footer class="bg-white shadow-inner mt-6">
    <div class="container mx-auto py-4 text-sm text-gray-500 px-4">
      <div class="flex flex-col items-center sm:flex-row sm:justify-between">

        <!-- Left side -->
        <span class="mb-2 sm:mb-0">WalletFlow | Powered by Hackanova</span>

        <!-- Right side -->
        <div class="flex space-x-6">
          <a href="helpage.html" class="hover:underline">Blog</a>
          <a href="contact.html" class="hover:underline">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Script -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ðŸ”¹ Replace with your Supabase project keys
    const SUPABASE_URL = "https://tpbfuyibluyflbajdehy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwYmZ1eWlibHV5ZmxiYWpkZWh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNzg5MzIsImV4cCI6MjA3Mzg1NDkzMn0.Y2KczDmRWCz9TuHIBWX8atYtA252p-30kv8iaXRd070";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadDashboard() {
      try {
        // ðŸ‘‰ Get budgets
        const { data: budgets } = await supabase
          .from("budgets")
          .select("fun_budget, penalty_jar")
          .limit(1);

        if (budgets && budgets.length > 0) {
          document.getElementById("funBudget").textContent = "â‚¹" + budgets[0].fun_budget;
          document.getElementById("penaltyJar").textContent = "â‚¹" + budgets[0].penalty_jar;
        }

        // ðŸ‘‰ Get last 7 days habits
        const { data: habits } = await supabase
          .from("habits")
          .select("date, completed, penalty_amount")
          .order("date", { ascending: true })
          .limit(7);

        const labels = habits?.map(h => new Date(h.date).toLocaleDateString("en-IN", { weekday: "short" })) || [];
        const streaks = habits?.map(h => (h.completed ? 1 : 0)) || [];
        const money = habits?.map(h => (h.completed ? 0 : -h.penalty_amount)) || [];

        // Render Chart
        const ctx = document.getElementById("habitChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Habit Streak",
                data: streaks,
                borderColor: "#4f46e5",
                backgroundColor: "rgba(79,70,229,0.2)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              },
              {
                label: "Money Shift (â‚¹)",
                data: money,
                borderColor: "#ef4444",
                backgroundColor: "rgba(239,68,68,0.2)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });
      } catch (err) {
        console.error("Error loading dashboard:", err);
      }
    }

    loadDashboard();



    // Check session
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      document.getElementById("loginModal").classList.remove("hidden");
    }

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message);
      } else {
        document.getElementById("loginModal").classList.add("hidden");
        loadDashboard(); // reload dashboard data
      }
    };

    // Signup
    document.getElementById("signupBtn").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) {
        alert(error.message);
      } else {
        alert("Signup successful. Please log in.");
      }
    };

    // Logout btn
    document.getElementById("logoutBtn").onclick = async () => {
      await supabase.auth.signOut();
      document.getElementById("loginModal").classList.remove("hidden");
    };

  </script>
</body>

</html>